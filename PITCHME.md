# Python для сетевых инженеров 

#HSLIDE

# Ansible

#VSLIDE
### Ansible

Ansible - это система управления конфигурациями. Ansible позволяет автоматизировать и упростить настройку, обслуживание и развертывание серверов, служб, ПО и др.

На данный момент существует несколько [систем управления конфигурациями](http://xgu.ru/wiki/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%B0_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F_%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B5%D0%B9).

Однако, для работы с сетевым оборудованием, чаще всего используется Ansible.
Связано это с тем, что Ansible не требует установки агента на управляемые хосты.
Особенно актуально это для устройств, которые позволяют работать с ними только через CLI.

Кроме того, Ansible активно развивается в сторону поддержки сетевого оборудования и постоянно появляются новые возможности и модули для работы с сетевым оборудованием.

#VSLIDE
### Ansible

Примеры задач, которые поможет решить Ansible:
* подключение по SSH к устройствам
 * паралелльное подключение к устройствам по SSH (можно указывать ко скольки устройствам подключаться одновременно)
* отправка команд на устройства
* удобный синтаксис описания устройств:
 * можно разбивать устройства на группы и затем отправлять какие-то команды на всю группу
* поддержка шаблонов конфигураций с Jinja2

#VSLIDE
### Установка Ansible

Ansible нужно устанавливать только на той машине, с которой будет выполняться управление устройствами.

Требования к управляющему хосту:
* поддержка Python 2.7 (или 2.6)
* Windows не может быть управляющим хостом

Ansible довольно часто обновляется, поэтому лучше установить его в виртуальном окружении.

#VSLIDE
### Установка Ansible

Установить Ansible можно [по-разному](http://docs.ansible.com/ansible/intro_installation.html#).

Например, с помощью pip:
```
$ pip install ansible==2.2.0.0
```

#VSLIDE
### Параметры оборудования

В примерах раздела используются три маршрутизатора и один коммутатор. К ним нет никаких требований, только настроенный SSH.

Параметры, которые используются в разделе:
* пользователь: cisco
* пароль: cisco
* пароль на режим enable: cisco
* SSH версии 2
* IP-адреса:
 * R1: 192.168.100.1
 * R2: 192.168.100.2
 * R3: 192.168.100.3
 * SW1: 192.168.100.100

#HSLIDE
## Основы Ansible

#VSLIDE
### Основы Ansible

Ansible:
* Работает без установки агента на управляемые хосты
* Использует SSH для подключения к управляемым хостам
* Выполняет изменения, с помощью модулей Python, которые выполняются на управляемых хостах
* Может выполнять действия локально, на управляющем хосте
* Использует YAML для описания сценариев
* Содержит множество модулей (их количество постоянно растет)
* Легко писать свои модули

#VSLIDE
### Терминология

* __Control machine__ —  управляющий хост. Сервер Ansible, с которого происходит управление другими хостами
* __Manage node__ —  управляемые хосты
* __Inventory__ —  инвентарный файл. В этом файле описываются хосты, группы хостов. А также могут быть созданы переменные
* __Playbook__ — файл сценариев
* __Play__ —  сценарий (набор задач). Связывает задачи с хостами, для которых эти задачи надо выполнить
* __Task__ —  задача. Вызывает модуль с указанными параметрами и переменными
* __Module__ — модуль Ansible. Реализует определенные функции


#VSLIDE
### Quick start

С Ansible очень просто начать работать. Минимум, который нужен для начала работы:
* инвентарный файл - в нем описываются устройства
* изменить конфигурацию Ansible, для работы с сетевым оборудованием
* разобраться с ad-hoc командами - это возможность выполнять простые действия с устройствами из командной строки
 * например, с помощью ad-hoc команд, можно отправить команду show на несколько устройств

Намного больше возможностей появится, при использовании playbook (файлы сценариев).
Но ad-hoc команды намного проще начать использовать. И с ними легче начать разбираться с Ansible.

#HSLIDE
## Инвентарный файл

#VSLIDE
### Инвентарный файл

Инвентарный файл - это файл, в котором описываются устройства, к которым Ansible будет подключаться.

В инвентарном файле устройства могут указываться используя IP-адреса или имена.
Устройства могут быть указаны по одному или разбиты на группы.

#VSLIDE
### Инвентарный файл

Файл описывается в формате INI. Пример файла:
```ini
r5.example.com

[cisco-routers]
192.168.255.1
192.168.255.2
192.168.255.3
192.168.255.4

[cisco-edge-routers]
192.168.255.1
192.168.255.2
```

#VSLIDE
### Инвентарный файл

Название, которое указано в квадратных скобках - это название группы.
В данном случае, созданы две группы устройств: cisco-routers и cisco-edge-routers.

Обратите внимание, что адреса 192.168.255.1 и 192.168.255.2 находятся в двух группах.
Это нормальная ситуация, один и тот же адрес или имя хоста, можно помещать в разные группы.

Таким образом можно применять отдельно какие-то политики для группы cisco-edge-routers, но в то же время, когда необходимо настроить что-то, что касается всех маршрутизаторов, можно использовать группу cisco-routers.

#VSLIDE
### Инвентарный файл

По умолчанию, файл находится в ```/etc/ansible/hosts```.

Но можно создавать свой инвентарный файл и использовать его.
Для этого нужно, либо указать его при запуске ansible, используя опцию ```-i <путь>```, либо указать файл в конфигурационном файле Ansible.

#VSLIDE
### Инвентарный файл

Если какое-то из устройств использует нестандартный порт SSH,
порт можно указать после имени или адреса устройства, через двоеточие (ниже показан пример).

Такой вариант указания порта работает только с подключениями OpenSSH и не работает с paramiko.

#VSLIDE
### Инвентарный файл

Пример инвентарного файла, с использованием нестандартных портов для SSH:
```ini
[cisco-routers]
192.168.255.1:22022
192.168.255.2:22022
192.168.255.3:22022

[cisco-switches]
192.168.254.1
192.168.254.2
```

#VSLIDE
### Инвентарный файл

Если в группу надо добавить несколько устройств с однотипными именами, можно использовать такой вариант записи:
```ini
[cisco-routers]
192.168.255.[1-5]
```

Такая запись означает, что в группу попадут устройства с адресами 192.168.255.1-192.168.255.5.

#VSLIDE
### Группа из групп

Ansible также позволяет объединять группы устройств в общую группу. Для этого используется специальный синтаксис:
```ini
[cisco-routers]
192.168.255.1
192.168.255.2
192.168.255.3

[cisco-switches]
192.168.254.1
192.168.254.2

[cisco-devices:children]
cisco-routers
cisco-switches
```


#HSLIDE
### Ad Hoc команды

#VSLIDE
### Ad Hoc команды

Ad-hoc команды - это возможность запустить какое-то действие Ansible из командной строки.

Такой вариант используется, как правило, в тех случаях, когда надо что-то проверить, например, работу модуля.
Или просто выполнить какое-то разовое действие, которое не нужно сохранять.

В любом случае, это простой и быстрый способ начать использовать Ansible.

#VSLIDE
### Ad Hoc команды

Сначала нужно создать в локальном каталоге инвентарный файл. Назовем его myhosts:
```
[cisco-routers]
192.168.100.1
192.168.100.2
192.168.100.3

[cisco-switches]
192.168.100.100
```

#VSLIDE
### Ad Hoc команды

При подключении к устройствам первый раз, сначала лучше подключиться к ним вручную, чтобы ключи устройств были сохранены локально. В Ansible есть возможность отключить эту первоначальную проверку ключей. В разделе о конфигурационном файле мы посмотрим как это делать (такой вариант может понадобиться, если надо подключаться к большому количеству устройств).

Пример ad-hoc команды:
```
$ ansible cisco-routers -i myhosts -m raw -a "sh ip int br" -u cisco --ask-pass
```

#VSLIDE
### Ad Hoc команды

Разберемся с параметрами команды:
* ```cisco-routers``` - группа устройств, к которым нужно применить действия
 * эта группа должна существовать в инвентарном файле
 * это может быть конкретное имя или адрес
 * если нужно указать все хосты из файла, можно использовать значение all или *
 * Ansible поддерживает более сложные варианты указания хостов, с регулярными выражениями и разными шаблонами. Подробнее об этом в [документации](http://docs.ansible.com/ansible/intro_patterns.html)

#VSLIDE
### Ad Hoc команды

* ```-i myhosts``` - параметр -i позволяет указать инвентарный файл
* ```-m raw -a "sh ip int br"``` - параметр ```-m raw``` означает, что используется модуль raw
 * этот модуль позволяет отправлять команды в SSH сессии, но при этом не загружает на хост модуль Python. То есть, этот модуль просто отправляет указанную команду как строку и всё
 * плюс модуля raw в том, что он может использоваться для любой системы, которую поддерживает Ansible
 * ```-a "sh ip int br"``` - параметр ```-a``` указывает какую команду отправить
* ```-u cisco``` - подключение выполняется от имени пользователя cisco
* ```--ask-pass``` - параметр который нужно указать, чтобы аутентификация была по паролю, а не по ключам

#VSLIDE
### Ad Hoc команды

Результат выполнения будет таким:
```
$ ansible cisco-routers -i myhosts -m raw -a "sh ip int br" -u cisco --ask-pass
```

![ad-hoc-fail](https://raw.githubusercontent.com/natenka/PyNEng/master/images/15_ansible/2_ad-hoc-fail.png)

#VSLIDE
### Ad Hoc команды

Ошибка значит, что нужно установить программу sshpass.
Эта особенность возникает только когда используется аутентификацию по паролю.

Установка sshpass:
```
$ sudo apt-get install sshpass
```

#VSLIDE
### Ad Hoc команды

Команду надо выполнить повторно:
```
$ ansible cisco-routers -i myhosts -m raw -a "sh ip int br" -u cisco --ask-pass
```

![ad-hoc](https://raw.githubusercontent.com/natenka/PyNEng/master/images/15_ansible/1_ad-hoc.png)


#VSLIDE
### Ad Hoc команды

Теперь всё прошло успешно.
Команда выполнилась и отобразился вывод с каждого устройства.

Аналогичным образом можно попробовать выполнять и другие команды и/или на других комбинациях устройств.

